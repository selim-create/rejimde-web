import fs from "node:fs";
import path from "node:path";
import axios from "axios";
import * as XLSX from "xlsx";

const XLSX_URL =
  "https://uetds.uab.gov.tr/uploads/pages/teknik-dokumanlar/ilce-listesi.xlsx";

function slugTR(str) {
  return String(str || "")
    .trim()
    .toLowerCase()
    .replace(/ğ/g, "g")
    .replace(/ü/g, "u")
    .replace(/ş/g, "s")
    .replace(/ı/g, "i")
    .replace(/ö/g, "o")
    .replace(/ç/g, "c")
    .replace(/â/g, "a")
    .replace(/î/g, "i")
    .replace(/û/g, "u")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "");
}

function norm(s) {
  return String(s ?? "").trim().replace(/\s+/g, " ");
}

function upperTR(s) {
  return norm(s).toUpperCase("tr");
}

// İlçe olmayan “alt lokasyon” kayıtlarını elemek için basit filtre.
// (Bu excelde bazen havalimanı/terminal vb. görünüyor.)
function isProbablyDistrictName(name) {
  const n = upperTR(name);

  // Çok agresif filtre istemiyoruz; sadece bariz “havalimanı, terminal, liman...” gibi
  const bannedWords = [
    "HAVALIMANI",
    "AİRPORT",
    "TERMINAL",
    "LİMAN",
    "PORT",
    "GARI",
    "OTOGAR",
    "İSKELE",
    "ISTASYON",
    "STATION",
    "METRO",
    "TRAMVAY",
  ];

  if (bannedWords.some((w) => n.includes(w))) return false;

  // Çok uzun “özel yer” isimleri genelde ilçe değildir
  if (n.length > 35) return false;

  return true;
}

async function main() {
  const outPath = path.resolve(process.cwd(), "locations.ts");

  const res = await axios.get(XLSX_URL, { responseType: "arraybuffer" });
  const wb = XLSX.read(res.data, { type: "buffer" });
  const ws = wb.Sheets[wb.SheetNames[0]];

  // 2D matrix (satır/sütun)
  const matrix = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

  if (!matrix.length) throw new Error("Excel sheet boş görünüyor.");

  // Header satırı zaten 0. satır gibi görünüyor:
  // [ 'KODU', 'IL_KODU', 'AD', 'IL_ADI' ]
  const header = (matrix[0] || []).map((x) => String(x).trim());

  const colIndex = (name) => header.findIndex((h) => h === name);

  const cityCol = colIndex("IL_ADI");
  const districtCol = colIndex("AD");

  if (cityCol === -1 || districtCol === -1) {
    console.error("❌ Header:", header);
    throw new Error("Beklenen kolonlar bulunamadı (IL_ADI / AD).");
  }

  const citiesMap = new Map(); // city -> Set(district)

  for (let r = 1; r < matrix.length; r++) {
    const row = matrix[r] || [];
    const cityRaw = row[cityCol];
    const districtRaw = row[districtCol];

    const city = norm(cityRaw);
    const district = norm(districtRaw);

    if (!city || !district) continue;

    // İl adları bu excelde genelde büyük harf geliyor, biz “Title Case”e çevirmiyoruz,
    // çünkü TR özel durumları var. İstersen burada dönüştürürüz.
    // Şimdilik resmi yazımı koruyalım:
    // ADANA, İSTANBUL, ŞANLIURFA...

    if (!isProbablyDistrictName(district)) continue;

    if (!citiesMap.has(city)) citiesMap.set(city, new Set());
    citiesMap.get(city).add(district);
  }

  // Bazı illerde bu kaynak “MERKEZ” gibi bir şey geçirebilir, istersen normalize ederiz.
  // (Şimdilik ham bırakıyorum.)

  const cityNames = Array.from(citiesMap.keys()).sort((a, b) =>
    a.localeCompare(b, "tr")
  );

  const cities = cityNames.map((cityName) => ({
    id: slugTR(cityName),
    name: cityName
      .toLowerCase("tr")
      .replace(/(^|\s)\p{L}/gu, (m) => m.toLocaleUpperCase("tr")), // ADANA -> Adana
    districts: Array.from(citiesMap.get(cityName)).sort((a, b) =>
      a.localeCompare(b, "tr")
    ).map((d) =>
      d.toLowerCase("tr").replace(/(^|\s)\p{L}/gu, (m) => m.toLocaleUpperCase("tr"))
    ),
  }));

  const districtsCount = cities.reduce((sum, c) => sum + c.districts.length, 0);

  const file = `/**
 * Auto-generated by scripts/generate-locations.mjs
 * Source: uetds.uab.gov.tr -> ilce-listesi.xlsx (columns: IL_ADI, AD)
 */
export const CITIES = ${JSON.stringify(cities, null, 2)} as const;

export type City = (typeof CITIES)[number];
`;

  fs.writeFileSync(outPath, file, "utf8");

  console.log(`✅ locations.ts generated: ${outPath}`);
  console.log(`✅ Cities: ${cities.length}`);
  console.log(`✅ Districts: ${districtsCount}`);
  console.log(`✅ Using columns -> city: IL_ADI (${cityCol}), district: AD (${districtCol})`);
}

main().catch((err) => {
  console.error("❌ Generation failed:", err?.message || err);
  process.exit(1);
});
